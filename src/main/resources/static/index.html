<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tire Change Workshop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>
<div class="container col-4">
    <h3 class="text-center">Tire Change Workshop</h3>
    <form>
        <div class="row text-center" id="vehicleType"></div>
        <hr>
        <div class="row text-center" id="workshopLocations">
            <div class="col">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" value="" id="all" checked>
                <label class="form-check-label" for="all">
                    All
                </label>
            </div>
            <div class="col">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" value="" id="manchester">
                <label class="form-check-label" for="manchester">
                    Manchester
                </label>
            </div>
            <div class="col">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" value="" id="london">
                <label class="form-check-label" for="london">
                    London
                </label>
            </div>
        </div>
        <hr>
        <div class="row text-center">
            <div class="col-6">
                <label for="from">From</label>
                <input id="from" class="form-control" data-date-format="DD MMMM YYYY" type="date"/>
            </div>
            <div class="col-6">
                <label for="until">Until</label>
                <input id="until" class="form-control" type="date" />
            </div>
        </div>
    </form>
    <hr>
    <table class="table table-hover">
        <thead>
        <tr>
            <th>Workshop</th>
            <th>Time</th>
            <th></th>
        </tr>
        </thead>
        <tbody id="availableTimes"></tbody>
    </table>
</div>

<!-- Set default dates onLoad -->
<script>
    function getDateString(days) {
        let today = new Date();
        let date = new Date(today.getFullYear(), today.getMonth(), today.getDate()+days);
        const dd = date.getDate();
        const mm = date.getMonth() + 1;
        const yyyy = date.getFullYear();
        return yyyy + '-' + ((mm<10) ? '0'+mm : mm) + '-' + ((dd<10) ? '0'+dd : dd);
    }
    function setDefaultDates(){
        document.getElementById("from").value = getDateString(0);
        document.getElementById("until").value = getDateString(6);
    }
    document.addEventListener("DOMContentLoaded", setDefaultDates)
</script>

<!-- GET supported vehicle types -->
<script>
    const apiUrl = 'http://localhost:8080/api/v1/workshop';

    async function getWorkshops(){
        return fetch(apiUrl, {
            method: 'GET',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(result => result.json());
    }

    async function getVehicleTypes(){
        let workshops = await getWorkshops();
        let vehicleTypes = new Set();
        workshops.forEach(workshop => {
            workshop.vehicles.forEach(type => vehicleTypes.add(type));
        })
        return vehicleTypes;
    }

    async function renderVehicles(){
        let vehicleTypes = await getVehicleTypes();
        let vehiclesCheckboxes     = '';
        vehicleTypes.forEach(type => {
            let checkbox = '<div class="col">' +
                                '<input class="form-check-input" type="radio" id="'+type+'" name="vehicle" onclick="renderAvailableTimes();">' +
                                '<label class="form-check-label ms-1" for="'+type+'+">' +
                                    type +
                                '</label>' +
                            '</div>';
            vehiclesCheckboxes += checkbox;
        });
        document.getElementById('vehicleType').innerHTML = vehiclesCheckboxes;
    }



    async function renderAvailableTimes(){
        let availableTimes  = await getAvailableTimes();
        let tbody     = '';
        availableTimes.forEach(time =>{
            let row = '<tr>' +
                '<td>'+time.workshop.name+'</td>' +
                '<td>'+time.time+'</td>' +
                '<td><button type="button" class="btn btn-outline-success">Book</button></td>' +
                '</tr>';
            tbody += row;
        });
        document.getElementById('availableTimes').innerHTML = tbody;
    }

    document.addEventListener("DOMContentLoaded", renderVehicles)
    //document.addEventListener("DOMContentLoaded", renderAvailableTimes)

</script>

<script>
    async function getAvailableTimes(){
        return [{
            "workshop": {
                "name": "London",
                "address": "1A Gunton Rd, London",
                "vehicles": [
                    "CAR"
                ]
            },
            "available": true,
            "uuid": "af1f1891-9d6e-49b5-b9a6-0f2c2c3b415a",
            "id": -1,
            "time": "2022-11-21T08:00:00Z"
        },
            {
                "workshop": {
                    "name": "London",
                    "address": "1A Gunton Rd, London",
                    "vehicles": [
                        "CAR"
                    ]
                },
                "available": true,
                "uuid": "dd3c1bca-89ca-4693-a7fe-0f7b2d42af86",
                "id": -1,
                "time": "2022-11-21T09:00:00Z"
            }]
    }
</script>

</body>
</html>